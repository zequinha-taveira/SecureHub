// ============================================
// VULNERABILITY SCANNER MODULE
// ============================================

function loadVulnerabilityScanner() {
    modalTitle.textContent = 'üõ°Ô∏è Scanner de Vulnerabilidades';
    modalBody.innerHTML = `
        <div class="alert alert-info">
            <strong>‚ÑπÔ∏è An√°lise de Cabe√ßalhos de Seguran√ßa</strong>
            <p style="margin-top: 0.5rem; font-size: 0.875rem;">
                Esta ferramenta simula a verifica√ß√£o de cabe√ßalhos HTTP de seguran√ßa e pr√°ticas recomendadas.
                Para an√°lise real, os cabe√ßalhos precisariam ser obtidos do servidor.
            </p>
        </div>
        
        <div class="form-group">
            <label class="form-label">URL do Site</label>
            <input type="text" id="scanUrl" class="form-input" placeholder="https://exemplo.com">
        </div>
        
        <button class="btn" onclick="scanVulnerabilities()">Analisar</button>
        
        <div id="scanResult" style="display: none; margin-top: 1.5rem;">
            <div id="scanScore"></div>
            
            <div style="margin-top: 1.5rem;">
                <h3 style="margin-bottom: 1rem;">Cabe√ßalhos de Seguran√ßa</h3>
                <div id="securityHeaders"></div>
            </div>
            
            <div style="margin-top: 1.5rem;">
                <h3 style="margin-bottom: 1rem;">Recomenda√ß√µes</h3>
                <div id="scanRecommendations"></div>
            </div>
        </div>
        
        <div style="margin-top: 2rem; padding: 1rem; background: var(--bg-tertiary); border-radius: var(--radius-md);">
            <h4 style="margin-bottom: 0.5rem;">üîí Cabe√ßalhos de Seguran√ßa Importantes</h4>
            <ul style="font-size: 0.875rem; color: var(--text-secondary); padding-left: 1.5rem; line-height: 1.8;">
                <li><strong>Strict-Transport-Security (HSTS):</strong> For√ßa conex√µes HTTPS</li>
                <li><strong>Content-Security-Policy (CSP):</strong> Previne XSS e inje√ß√£o de c√≥digo</li>
                <li><strong>X-Frame-Options:</strong> Protege contra clickjacking</li>
                <li><strong>X-Content-Type-Options:</strong> Previne MIME sniffing</li>
                <li><strong>Referrer-Policy:</strong> Controla informa√ß√µes de refer√™ncia</li>
                <li><strong>Permissions-Policy:</strong> Controla recursos do navegador</li>
            </ul>
        </div>
    `;
}

function scanVulnerabilities() {
    const urlInput = document.getElementById('scanUrl').value.trim();

    if (!urlInput) {
        showNotification('Digite uma URL para analisar', 'warning');
        return;
    }

    let url;
    try {
        url = new URL(urlInput);
    } catch (e) {
        showNotification('URL inv√°lida', 'error');
        return;
    }

    document.getElementById('scanResult').style.display = 'block';

    // Simulate security header check
    // In production, this would require a backend to fetch actual headers
    const headers = simulateSecurityHeaders(url);

    let score = 0;
    const maxScore = 100;
    const checks = [];

    // HTTPS check
    if (url.protocol === 'https:') {
        score += 20;
        checks.push({
            name: 'HTTPS',
            status: 'pass',
            message: 'Site usa HTTPS (conex√£o segura)'
        });
    } else {
        checks.push({
            name: 'HTTPS',
            status: 'fail',
            message: 'Site n√£o usa HTTPS - conex√£o insegura'
        });
    }

    // Security headers checks
    const headerChecks = [
        { header: 'Strict-Transport-Security', points: 15, name: 'HSTS' },
        { header: 'Content-Security-Policy', points: 20, name: 'CSP' },
        { header: 'X-Frame-Options', points: 15, name: 'X-Frame-Options' },
        { header: 'X-Content-Type-Options', points: 10, name: 'X-Content-Type-Options' },
        { header: 'Referrer-Policy', points: 10, name: 'Referrer-Policy' },
        { header: 'Permissions-Policy', points: 10, name: 'Permissions-Policy' }
    ];

    headerChecks.forEach(check => {
        if (headers[check.header]) {
            score += check.points;
            checks.push({
                name: check.name,
                status: 'pass',
                message: `${check.header} configurado`,
                value: headers[check.header]
            });
        } else {
            checks.push({
                name: check.name,
                status: 'fail',
                message: `${check.header} n√£o encontrado`
            });
        }
    });

    // Determine grade
    let grade, gradeColor, gradeText;
    if (score >= 90) {
        grade = 'A';
        gradeColor = 'var(--success)';
        gradeText = 'Excelente! O site implementa as melhores pr√°ticas de seguran√ßa.';
    } else if (score >= 70) {
        grade = 'B';
        gradeColor = 'var(--info)';
        gradeText = 'Bom n√≠vel de seguran√ßa, mas h√° espa√ßo para melhorias.';
    } else if (score >= 50) {
        grade = 'C';
        gradeColor = 'var(--warning)';
        gradeText = 'Seguran√ßa b√°sica implementada, v√°rias melhorias recomendadas.';
    } else {
        grade = 'D';
        gradeColor = 'var(--error)';
        gradeText = 'Seguran√ßa inadequada. Implementa√ß√µes cr√≠ticas est√£o faltando.';
    }

    // Display score
    document.getElementById('scanScore').innerHTML = `
        <div class="alert" style="border-color: ${gradeColor};">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3>Nota de Seguran√ßa: <span style="color: ${gradeColor}; font-size: 2rem;">${grade}</span></h3>
                    <p style="margin-top: 0.5rem;">${gradeText}</p>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 3rem; font-weight: 800; color: ${gradeColor};">
                        ${score}
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.875rem;">
                        de ${maxScore}
                    </div>
                </div>
            </div>
            <div style="margin-top: 1rem;">
                <div style="background: var(--bg-tertiary); height: 12px; border-radius: 6px; overflow: hidden;">
                    <div style="height: 100%; width: ${score}%; background: ${gradeColor}; transition: width 0.5s;"></div>
                </div>
            </div>
        </div>
    `;

    // Display headers
    const headersHtml = checks.map(check => {
        let icon, color;
        if (check.status === 'pass') {
            icon = '‚úÖ';
            color = 'var(--success)';
        } else {
            icon = '‚ùå';
            color = 'var(--error)';
        }

        return `
            <div style="padding: 0.75rem; border-bottom: 1px solid var(--glass-border);">
                <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 0.25rem;">
                            ${icon} ${check.name}
                        </div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary);">
                            ${check.message}
                        </div>
                        ${check.value ? `
                            <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 0.25rem; font-family: 'Courier New', monospace;">
                                ${check.value}
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');

    document.getElementById('securityHeaders').innerHTML = `
        <div class="result-box" style="padding: 0;">
            ${headersHtml}
        </div>
    `;

    // Recommendations
    const failedChecks = checks.filter(c => c.status === 'fail');
    let recommendations = '';

    if (failedChecks.length === 0) {
        recommendations = `
            <div class="alert alert-success">
                <strong>üéâ Parab√©ns!</strong>
                <p style="margin-top: 0.5rem;">
                    Todas as verifica√ß√µes de seguran√ßa passaram. Continue mantendo as boas pr√°ticas!
                </p>
            </div>
        `;
    } else {
        const recommendationsList = failedChecks.map(check => {
            const rec = getRecommendation(check.name);
            return `
                <li style="margin-bottom: 1rem;">
                    <strong>${check.name}:</strong> ${rec}
                </li>
            `;
        }).join('');

        recommendations = `
            <div class="result-box">
                <ul style="padding-left: 1.5rem; line-height: 1.8;">
                    ${recommendationsList}
                </ul>
            </div>
        `;
    }

    document.getElementById('scanRecommendations').innerHTML = recommendations;
}

function simulateSecurityHeaders(url) {
    // Simulate headers based on common patterns
    // In production, these would be fetched from the actual server
    const headers = {};

    if (url.protocol === 'https:') {
        // Simulate that HTTPS sites are more likely to have security headers
        if (Math.random() > 0.3) {
            headers['Strict-Transport-Security'] = 'max-age=31536000; includeSubDomains';
        }
        if (Math.random() > 0.5) {
            headers['X-Frame-Options'] = 'SAMEORIGIN';
        }
        if (Math.random() > 0.6) {
            headers['X-Content-Type-Options'] = 'nosniff';
        }
        if (Math.random() > 0.7) {
            headers['Content-Security-Policy'] = "default-src 'self'";
        }
        if (Math.random() > 0.8) {
            headers['Referrer-Policy'] = 'strict-origin-when-cross-origin';
        }
        if (Math.random() > 0.8) {
            headers['Permissions-Policy'] = 'geolocation=(), microphone=()';
        }
    }

    return headers;
}

function getRecommendation(headerName) {
    const recommendations = {
        'HTTPS': 'Configure um certificado SSL/TLS para habilitar HTTPS. Servi√ßos como Let\'s Encrypt oferecem certificados gratuitos.',
        'HSTS': 'Adicione o cabe√ßalho Strict-Transport-Security para for√ßar conex√µes HTTPS: "Strict-Transport-Security: max-age=31536000; includeSubDomains"',
        'CSP': 'Implemente Content-Security-Policy para prevenir XSS: "Content-Security-Policy: default-src \'self\'"',
        'X-Frame-Options': 'Adicione X-Frame-Options para prevenir clickjacking: "X-Frame-Options: SAMEORIGIN"',
        'X-Content-Type-Options': 'Configure X-Content-Type-Options para prevenir MIME sniffing: "X-Content-Type-Options: nosniff"',
        'Referrer-Policy': 'Defina Referrer-Policy para controlar informa√ß√µes de refer√™ncia: "Referrer-Policy: strict-origin-when-cross-origin"',
        'Permissions-Policy': 'Configure Permissions-Policy para controlar recursos do navegador: "Permissions-Policy: geolocation=(), microphone=()"'
    };

    return recommendations[headerName] || 'Configure este cabe√ßalho de seguran√ßa no servidor.';
}
